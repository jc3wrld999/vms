<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/default_layout}"
>
  <!-- layout Content -->
  <th:block layout:fragment="content-wrapper">
    <div class="content-wrapper">
      <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.css" rel="stylesheet">
      <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.js"></script>
          <style>
            body {
                color:#404040;
                font:400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
                margin:0;
                padding:0;
                -webkit-font-smoothing:antialiased;
              }
      
              * {
                -webkit-box-sizing:border-box;
                -moz-box-sizing:border-box;
                box-sizing:border-box;
              }
      
              .sidebar {
                position:absolute;
                width:33.3333%;
                height:100%;
                top:0;right:0;
                overflow:hidden;
                border-right:1px solid rgba(0,0,0,0.25);
      
                -webkit-transition: width 500ms, height 500ms; /* For Safari 3.1 to 6.0 */
                transition: width 500ms, height 500ms;
              }
              .pad2 {
                padding:20px;
              }
      
              .map {
                position:absolute;
                right:33.3333%;
                width:66.6666%;
                top:0;bottom:0;
      
                -webkit-transition: width 500ms, height 500ms, left 500ms; /* For Safari 3.1 to 6.0 */
                transition: width 500ms, height 500ms, left 500ms;
              }
      
              h1 {
                font-size:22px;
                margin:0;
                font-weight:400;
                line-height: 20px;
                padding: 20px 2px;
              }
      
              a {
                color:#404040;
                text-decoration:none;
              }
      
              a:hover {
                color:#101010;
              }
      
              .heading {
                /* background:#fff; */
                border-bottom:1px solid #eee;
                min-height:60px;
                line-height:60px;
                padding:0 10px;
              }
      
              .listings {
                height:100%;
                overflow:auto;
                padding-bottom:60px;
              }
      
              .listings .item {
                display:block;
                border-bottom:1px solid #eee;
                padding:10px;
                text-decoration:none;
              }
      
              .listings .item:last-child { border-bottom:none; }
              .listings .item .title {
                display:block;
                color:#00853e;
                font-weight:700;
              }
      
              .listings .item .title small { font-weight:400; }
              .listings .item.active .title,
              .listings .item .title:hover { color:#8cc63f; }
              .listings .item.active {
                background-color:#f8f8f8;
              }
              ::-webkit-scrollbar {
                width:3px;
                height:3px;
                border-left:0;
                background:rgba(0,0,0,0.1);
              }
              ::-webkit-scrollbar-track {
                background:none;
              }
              ::-webkit-scrollbar-thumb {
                background:#00853e;
                border-radius:0;
              }
      
              .marker {
                border: none;
                cursor: pointer;
                height: 56px;
                width: 56px;
                background-image: url(https://www.mapbox.com/help/demos/gl-store-locator/marker.png);
                background-color: rgba(0, 0, 0, 0);
                transform: translate(28px, 56px, 0);
              }
      
              .clearfix { display:block; }
              .clearfix:after {
                content:'.';
                display:block;
                height:0;
                clear:both;
                visibility:hidden;
              }
      
              /* Marker tweaks */
              .mapboxgl-popup {
                padding-bottom: 50px;
              }
      
              .mapboxgl-popup-close-button {
                display:none;
              }
              .mapboxgl-popup-content {
                font:400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
                padding:0;
                width:180px;
              }
              .mapboxgl-popup-content-wrapper {
                padding:1%;
              }
              .mapboxgl-popup-content h3 {
                background:#91c949;
                color:#fff;
                margin:0;
                display:block;
                padding:10px;
                border-radius:3px 3px 0 0;
                font-weight:700;
                margin-top:-15px;
              }
      
              .mapboxgl-popup-content h4 {
                margin:0;
                display:block;
                padding: 10px 10px 10px 10px;
                font-weight:400;
                margin: 0;
              }
      
              .mapboxgl-popup-content div {
                padding:10px;
              }
      
              .mapboxgl-container .leaflet-marker-icon {
                cursor:pointer;
              }
      
              .mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
                margin-top: 15px;
              }
      
              .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
                border-bottom-color: #91c949;
              }
            
            #toggle_sidebar {
              min-height: 20px;
              background-color: #3887be;
              color: #fff;
              font-family: 'Open Sans';
              border-radius: 5px;
              padding: 10px;
              cursor: pointer;
              margin: 10px 10px;
              position: absolute; top: 0; right: 0; z-index: 999999;
            }
          </style>
          </head>
      
        <body>
      
      <!--     <div id='toggle_sidebar' onclick="onClick()" class='button button'>Toggle sidebar</div> -->
      
          <div id="sidebar" class='sidebar'>
            <div class='heading'>
              <h1 id="heading-num"></h1>
            </div>
          <div id='listings' class='listings'></div>
          </div>
          <div id='map' class='map'> </div>
      
      <div id="map"></div>
      
      <script>
        // TO MAKE THE MAP APPEAR YOU MUST
        // ADD YOUR ACCESS TOKEN FROM
        // https://account.mapbox.com
        mapboxgl.accessToken = 'pk.eyJ1IjoiamMzd3JsZDk5OSIsImEiOiJjbDRtdGV3ODEwMm9wM2ttZXpjZHRnZHFhIn0.3WMaZZTngmkKBFLQY1IgcQ'; // 계정에 있는 Public Access Token 입력
      
        // This will let you use the .remove() function later on
        if (!('remove' in Element.prototype)) {
          Element.prototype.remove = function() {
            if (this.parentNode) {
                this.parentNode.removeChild(this);
            }
          };
        }
      
        // This adds the map
        var map = new mapboxgl.Map({
          // container id specified in the HTML
          container: 'map',
          // style URL
          style: 'mapbox://styles/mapbox/streets-v9',
          // initial position in [long, lat] format
          center: [126.886199, 37.476106],
          // initial zoom
          zoom: 13
        });

        var stores = {};
      
        $(function() {
          $.ajax({
            url: "/api/rest/getArrInfoByRouteAll/100100118",
                      type: "get",
                      data: { idArr: "test" },
                      dataType: "JSON",
                      success: function(r) {
                        console.log(r);
                        // form.submit();
                        // var obj = JSON.parse(r);
                        // console.log(obj.msgBody);
                        getArrInfoByRouteAll(r["msgBody"]["itemList"]);
                        // console.log(r["msgBody"]);
                        // $.each(r["msgBody"]["itemList"], function(index, item) {
                        //   console.log(item["stNm"]);
                        // })
                      },
                      error: function(e) {
                        console.log(e);
                      }
          });
              });
      
        // var toggle = true;
      
        // var onClick = function () {
        //   toggle = !toggle;
      
        //   var sidebarElement = document.getElementById('sidebar');
        //   var mapElement = document.getElementById('map');
      
        //   if (toggle) {
        //     sidebarElement.style.width = '33.3333%';
        //     mapElement.style.width = '66.6666%';
        //     mapElement.style.left = '33.3333%';
        //   } else {
        //     sidebarElement.style.width = '0'
        //     mapElement.style.width = '100%';
        //     mapElement.style.left = '0';
        //   }
      
        //   map.resize();
        // };
      
        // var stores = {
        //   "type": "FeatureCollection",
        //   "features": [
        //     {
        //       "type": "Feature",
        //       "geometry": {
        //         "type": "Point",
        //         "coordinates": [
        //           -77.034084142948,
        //           38.909671288923
        //         ]
        //       },
        //       "properties": {
        //         "phoneFormatted": "(202) 234-7336",
        //         "phone": "2022347336",
        //         "address": "1471 P St NW",
        //         "city": "Washington DC",
        //         "country": "United States",
        //         "crossStreet": "at 15th St NW",
        //         "postalCode": "20005",
        //         "state": "D.C."
        //       }
        //     }]
        //   };
        // This adds the data to the map
        map.on('load', function (e) {
          // This is where your '.addLayer()' used to be, instead add only the source without styling a layer
          map.addSource("places", {
            "type": "geojson",
            
          });
    //       map.addLayer({
    //     "id": "route",
    //     "type": "line",
    //     "source": {
    //         "type": "geojson",
    //         "data": {
    //             "type": "Feature",
    //             "properties": {},
    //             "geometry": {
    //                 "type": "LineString",
    //                 "coordinates": [
    //                     [-122.48369693756104, 37.83381888486939],
    //                     [-122.48348236083984, 37.83317489144141],
    //                     [-122.48339653015138, 37.83270036637107],
    //                     [-122.48356819152832, 37.832056363179625],
    //                     [-122.48404026031496, 37.83114119107971],
    //                     [-122.48404026031496, 37.83049717427869],
    //                     [-122.48348236083984, 37.829920943955045],
    //                     [-122.48356819152832, 37.82954808664175],
    //                     [-122.48507022857666, 37.82944639795659],
    //                     [-122.48610019683838, 37.82880236636284],
    //                     [-122.48695850372314, 37.82931081282506],
    //                     [-122.48700141906738, 37.83080223556934],
    //                     [-122.48751640319824, 37.83168351665737],
    //                     [-122.48803138732912, 37.832158048267786],
    //                     [-122.48888969421387, 37.83297152392784],
    //                     [-122.48987674713133, 37.83263257682617],
    //                     [-122.49043464660643, 37.832937629287755],
    //                     [-122.49125003814696, 37.832429207817725],
    //                     [-122.49163627624512, 37.832564787218985],
    //                     [-122.49223709106445, 37.83337825839438],
    //                     [-122.49378204345702, 37.83368330777276]
    //                 ]
    //             }
    //         }
    //     },
    //     "layout": {
    //     },
    //     "paint": {
    //         "line-color": "#888",
    //         "line-width": 8,
    //         "line-dasharray": [0, 4, 3]
    //     }
    // });
          // Initialize the list
          buildLocationList(stores);
      
        });
      
        // This is where your interactions with the symbol layer used to be
        // Now you have interactions with DOM markers instead
        stores.features.forEach(function(marker, i) {
          // Create an img element for the marker
          var el = document.createElement('div');
          el.id = "marker-" + i;
          el.className = 'marker';
          el.style.left='-28px';
          el.style.top='-46px';
          // Add markers to the map at all points
          new mapboxgl.Marker(el)
              .setLngLat(marker.geometry.coordinates)
              .addTo(map);
      
          el.addEventListener('click', function(e){
              // 1. Fly to the point
              flyToStore(marker);
      
              // 2. Close all other popups and display popup for clicked store
              createPopUp(marker);
      
              // 3. Highlight listing in sidebar (and remove highlight for all other listings)
              var activeItem = document.getElementsByClassName('active');
      
              e.stopPropagation();
              if (activeItem[0]) {
                 activeItem[0].classList.remove('active');
              }
      
              var listing = document.getElementById('listing-' + i);
              listing.classList.add('active');
      
          });
        });
      
      
        function flyToStore(currentFeature) {
          map.flyTo({
              center: currentFeature.geometry.coordinates,
              zoom: 15
            });
        }
      
        function createPopUp(currentFeature) {
          var popUps = document.getElementsByClassName('mapboxgl-popup');
          if (popUps[0]) popUps[0].remove();
      
      
          var popup = new mapboxgl.Popup({closeOnClick: false})
                .setLngLat(currentFeature.geometry.coordinates)
                .setHTML('<h3>Sweetgreen</h3>' +
                  '<h4>' + currentFeature.properties.address + '</h4>')
                .addTo(map);
        }
      
      
        function getArrInfoByRouteAll(data) {
          document.getElementById('heading-num').innerHTML = data[0]["rtNm"] + "번 버스 도착정보";
          for (i = 0; i < data.length; i++) {
            var currentFeature = data[i];
            console.log(currentFeature);
            var prop = currentFeature.properties;
            console.log(prop);
            var listings = document.getElementById('listings');
            var listing = listings.appendChild(document.createElement('div'));
            listing.className = 'item';
            listing.id = "listing-" + i;
      
            var link = listing.appendChild(document.createElement('a'));
            link.href = '#';
            link.className = 'title';
            link.dataPosition = i;
            link.innerHTML = currentFeature["stNm"];
      
            var details = listing.appendChild(document.createElement('div'));
            details.innerHTML = currentFeature["arrmsg1"];
            details.innerHTML += ' &middot; ' + currentFeature["arrmsg2"];

      
      
      
            // link.addEventListener('click', function(e){
            //   // Update the currentFeature to the store associated with the clicked link
            //   var clickedListing = data.features[this.dataPosition];
      
            //   // 1. Fly to the point
            //   flyToStore(clickedListing);
      
            //   // 2. Close all other popups and display popup for clicked store
            //   createPopUp(clickedListing);
      
            //   // 3. Highlight listing in sidebar (and remove highlight for all other listings)
            //   var activeItem = document.getElementsByClassName('active');
      
            //   if (activeItem[0]) {
            //      activeItem[0].classList.remove('active');
            //   }
            //   this.parentNode.classList.add('active');
      
      
      
      
            // });
          }
        }

        function getStaionsByPosList() {
          document.getElementById('heading-num').innerHTML = data[0]["rtNm"] + "번 버스 도착정보";
          for (i = 0; i < data.length; i++) {
            var currentFeature = data[i];
            console.log(currentFeature);
            var prop = currentFeature.properties;
            console.log(prop);
            var listings = document.getElementById('listings');
            var listing = listings.appendChild(document.createElement('div'));
            listing.className = 'item';
            listing.id = "listing-" + i;
      
            var link = listing.appendChild(document.createElement('a'));
            link.href = '#';
            link.className = 'title';
            link.dataPosition = i;
            link.innerHTML = currentFeature["stNm"];
      
            var details = listing.appendChild(document.createElement('div'));
            details.innerHTML = currentFeature["arrmsg1"];
            details.innerHTML += ' &middot; ' + currentFeature["arrmsg2"];

      
      
      
            // link.addEventListener('click', function(e){
            //   // Update the currentFeature to the store associated with the clicked link
            //   var clickedListing = data.features[this.dataPosition];
      
            //   // 1. Fly to the point
            //   flyToStore(clickedListing);
      
            //   // 2. Close all other popups and display popup for clicked store
            //   createPopUp(clickedListing);
      
            //   // 3. Highlight listing in sidebar (and remove highlight for all other listings)
            //   var activeItem = document.getElementsByClassName('active');
      
            //   if (activeItem[0]) {
            //      activeItem[0].classList.remove('active');
            //   }
            //   this.parentNode.classList.add('active');
      
      
      
      
            // });
          }
        }
        function enableLineAnimation(layerId) {
  var step = 0;
  let dashArraySeq = [
    [0, 4, 3],
    [1, 4, 2],
    [2, 4, 1],
    [3, 4, 0],
    [0, 1, 3, 3],
    [0, 2, 3, 2],
    [0, 3, 3, 1]
  ];
  setInterval(() => {
      step = (step + 1) % dashArraySeq.length;
      map.setPaintProperty(layerId, 'line-dasharray', dashArraySeq[step]);
    }, animationStep);
}

      
      </script>
    </div>
  </th:block>
</html>


